# ADR-01: JWT TTL, Refresh Token and Key Rotation

**Status:** `Proposed`

## Context

*   **Risk:** `R-01` "Подделка личности пользователя через украденные или повторно использованные JWT" (L=4, I=5, Score=20)
*   **DFD:** Ребро: Интернет → Шлюз API
*   **NFR:** `NFR-012`
*   **Assumptions:** Публичный API, необходимость поддерживать длительные сессии без частого повторного входа.

## Decision

Мы внедряем механизм Refresh Token для управления сессиями. Это позволит использовать короткоживущие Access токены (15 минут), минимизируя риск их компрометации, и долгоживущие Refresh токены (7 дней) для продления сессии без повторной аутентификации.

*   **Access Token TTL:** `15 минут`.
*   **Refresh Token TTL:** `7 дней`.
*   **Endpoint:** `/api/auth/refresh` для обмена Refresh Token на новую пару токенов.
*   **Key Rotation:** Настроить ротацию ключей подписи (JWKS) для Access токенов.
*   **Revocation:** Refresh токены должны отзываться при выходе пользователя из системы (`logout`).

## Alternatives

*   **Stateful JWTs (хранение состояния на сервере):** Отклонено из-за увеличения сложности архитектуры, добавления новой точки отказа (Redis) и снижения производительности.

## Consequences

*   **Положительные:**
    *   Значительно сокращается окно для атаки в случае кражи Access Token.
    *   Улучшается управляемость сессиями (возможность отзыва Refresh Token).
*   **Негативные/издержки:**
    *   Усложняется логика на стороне клиента (необходимо обрабатывать истечение Access Token и запрашивать новый).
    *   Требуется дополнительное хранилище для отозванных Refresh токенов.

## DoD / Acceptance

*   **Given:** Пользователь имеет валидный, но истекший Access Token и валидный Refresh Token.
*   **When:** Пользователь отправляет запрос на `/api/auth/refresh` с Refresh Token.
*   **Then:** Сервер возвращает новую пару Access и Refresh токенов.
*   **Checks:**
    *   **test:** Автотест, проверяющий, что запрос с истекшим Access Token отклоняется (401), а `refresh` эндпоинт успешно возвращает новую пару токенов.
    *   **log:** Логи содержат информацию об успешном обновлении токена.
    *   **metric/SLO:** Время ответа эндпоинта `/api/auth/refresh` P95 <= 200ms.

## Rollback / Fallback

Можно временно увеличить TTL Access Token через конфигурацию до прежних значений (например, 24 часа), если реализация Refresh Token вызовет проблемы.

## Trace

*   **DFD:** Ребро: `Интернет → Шлюз API` в `docs/seminars/S04/files/S04_dfd.md`.
*   **Risk scoring:** `R-01` (Top-1) в `docs/seminars/S04/files/S04_risk_scoring.md`.
*   **NFR:** `NFR-012` в `docs/seminars/S03/files/user-stories.md`.

## Ownership & Dates

*   **Owner:** `backend-dev`
*   **Date created:** 2025-10-12
