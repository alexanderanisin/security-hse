# ADR-03: Server-Side RBAC Enforcement

**Status:** `Proposed`

## Context

*   **Risk:** `R-03` "Повышение привилегий через редактирование JWT" (L=3, I=5, Score=15)
*   **DFD:** Узел: Сервис
*   **NFR:** `NFR-012`
*   **Assumptions:** Роли пользователей хранятся в базе данных как надежном источнике правды.

## Decision

Мы отказываемся от хранения ролей или прав доступа в JWT. Вместо этого, JWT будет содержать только идентификатор пользователя (`user_id`). При каждом запросе, требующем авторизации, роли пользователя будут загружаться из базы данных или кэша на стороне сервера. Это полностью устраняет вектор атаки, связанный с подделкой JWT.

*   **JWT Payload:** JWT будет содержать только `user_id`, `exp` и другую некритичную мета-информацию. Поле `roles` удаляется.
*   **Authorization Middleware:** Будет реализован middleware, который извлекает `user_id` из токена и загружает актуальные права пользователя из БД.
*   **Caching:** Для снижения нагрузки на БД роли могут кэшироваться на короткое время (e.g., 1-5 минут).

## Alternatives

*   **Signed JWT with Role Claims:** Отклонено. Хотя подпись токена снижает риск, она не устраняет его полностью, особенно в случае компрометации ключа подписи. Выбранный подход является более надежным.

## Consequences

*   **Положительные:**
    *   Полное устранение риска повышения привилегий через манипуляцию с JWT.
    *   Изменения прав доступа пользователя вступают в силу практически мгновенно (после истечения кэша).
*   **Негативные/издержки:**
    *   Увеличение задержки из-за дополнительного запроса к БД/кэшу на каждый авторизованный запрос.
    *   Появляется зависимость от доступности сервиса аутентификации/БД.

## DoD / Acceptance

*   **Given:** JWT, в который вручную добавлено поле `"roles": ["admin"]`.
*   **When:** Запрос с этим токеном поступает на эндпоинт, требующий прав администратора.
*   **Then:** Сервер отклоняет запрос с ошибкой `403 Forbidden`, так как реальные права загружаются из БД.
*   **Checks:**
    *   **test:** Интеграционный тест, который проверяет, что самодельный JWT с поддельными ролями не дает доступа.
    *   **log:** В логах отсутствуют ошибки, связанные с чтением ролей из токена.
    *   **metric/SLO:** Дополнительная задержка на middleware авторизации не превышает P99 50ms.

## Rollback / Fallback

Можно использовать feature flag для временного переключения на старую логику (чтение ролей из JWT), если новая реализация вызовет проблемы с производительностью.

## Trace

*   **DFD:** Узел: `Сервис` в `docs/seminars/S04/files/S04_dfd.md`.
*   **Risk scoring:** `R-03` (Top-3) в `docs/seminars/S04/files/S04_risk_scoring.md`.
*   **NFR:** `NFR-012` в `docs/seminars/S03/files/user-stories.md`.

## Ownership & Dates

*   **Owner:** `backend-dev`
*   **Date created:** 2025-10-12
