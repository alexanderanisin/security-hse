# S05 - Матрица вариантов (Option Matrix) для R-03

---

## 0) Контекст риска (из S04)

* **Risk-ID:** `R-03`     **Threat:** `E`
* **DFD element/edge:** Узел: Сервис
* **NFR link (ID):** `NFR-012`
* **L×I (1-5):** `L=3, I=5, Score=15`
* **Ограничения/предпосылки:** В JWT могут храниться роли пользователя для удобства, что создает вектор атаки.

---

## 1) Критерии и шкалы (1-5)

**Польза (↑):**

* **Security impact:** Насколько альтернатива снижает риск.
* **Blast radius reduction:** Насколько сужает возможный ущерб.

**Стоимость/сложность (↓):**

* **Complexity:** Сложность внедрения.
* **Time-to-mitigate:** Время до эффекта.
* **Dependencies:** Внешние/внутренние зависимости.

---

## 2) Таблица сравнения вариантов

| Alternative | Summary (1-2 фразы) | Security impact (↑,1-5) | Blast radius reduction (↑,1-5) | Complexity (↓,1-5) | Time-to-mitigate (↓,1-5) | Dependencies (↓,1-5) | **Benefit** | **Cost** | **Net** | Notes |
| ----------- | ------------------- | ----------------------: | -----------------------------: | -----------------: | -----------------------: | -------------------: | ----------: | -------: | ------: | ----- |
| A | **Server-Side Role Fetching.** Не хранить роли в JWT. Загружать их из БД/сервиса по `user_id` при каждом запросе. | 5 | 5 | 3 | 2 | 2 | **10** | **7** | **+3** | Полностью устраняет вектор атаки, но добавляет нагрузку на БД. |
| B | **Signed JWT with Role Claims.** Хранить роли в JWT, но подписывать токен асимметричным ключом (RS256) и строго валидировать. | 3 | 3 | 2 | 2 | 2 | **6** | **6** | **0** | Не устраняет риск полностью, если ключ подписи скомпрометирован. |

---

## 3) Тай-брейкеры при равенстве Net

Не требуется.

---

## 4) Решение (для переноса в ADR)

* **Chosen alternative:** `A`
* **Почему:** Альтернатива A (`Server-Side Role Fetching`) является наиболее надежным решением, так как полностью устраняет возможность подделки ролей путем модификации JWT. Хотя это создает дополнительный запрос к источнику данных, это приемлемая плата за устранение критического риска повышения привилегий.
* **ADR candidate (название):** `Server-Side RBAC Enforcement`
* **Связки:** Risk-ID `R-03`, NFR-ID `NFR-012`, DFD `Узел: Сервис`
* **Следующие шаги (минимум):**
    * Изменить логику генерации JWT, чтобы он содержал только `user_id` и `exp`.
    * Реализовать middleware, который извлекает `user_id` из токена и загружает роли пользователя из БД.
    * Передать полученные роли в контекст запроса для использования в бизнес-логике.
    * Провести рефакторинг кода, чтобы проверки прав доступа опирались на роли из контекста запроса, а не из JWT.
