# ADR-02: User Registration Input Validation

**Status:** `Proposed`

## Context

*   **Risk:** `R-02` "Подделка пользовательского ввода, приводящая к инъекционным атакам" (L=3, I=5, Score=15)
*   **DFD:** Ребро: Шлюз API → Сервис
*   **NFR:** `NFR-002`
*   **Assumptions:** Регистрация является публично доступным эндпоинтом и основной точкой входа для новых пользователей.

## Decision

Мы внедряем строгую валидацию на стороне сервера для полей, передаваемых при регистрации пользователя (`POST /api/auth/register`). Это защитит систему от слабых учетных данных и невалидных данных, которые могут вызвать ошибки или быть использованы для атак.

*   **Email Validation:** Адрес электронной почты должен соответствовать формату RFC5322.
*   **Password Complexity:** Пароль должен содержать минимум 8 символов, включая хотя бы одну цифру и один специальный символ.
*   **Field Strictness:** Запрос должен содержать только ожидаемые поля (`email`, `password`, `confirmPassword`). Лишние поля отклоняются.
*   **Error Response:** Ошибки валидации возвращают `400 Bad Request` в формате RFC7807 с четким указанием на некорректное поле.

## Alternatives

*   **Client-Side Validation Only:** Отклонено. Клиентская валидация может быть легко обойдена, поэтому серверная валидация обязательна.
*   **General Gateway Validation:** Отклонено в пользу более специфичного ADR, сфокусированного на критическом процессе регистрации.

## Consequences

*   **Положительные:**
    *   Повышается безопасность учетных записей за счет требований к сложности пароля.
    *   Снижается риск инъекций и ошибок обработки данных благодаря строгой проверке формата.
*   **Негативные/издержки:**
    *   Может незначительно увеличить время отклика эндпоинта регистрации.

## DoD / Acceptance

*   **Given:** Запрос на `POST /api/auth/register` с невалидным email (например, "user@.com") или паролем, не соответствующим политике (например, "password").
*   **When:** Запрос поступает на сервер.
*   **Then:** Сервер возвращает `400 Bad Request` с указанием на поле `email` или `password` и причиной ошибки.
*   **Checks:**
    *   **test:** Модульные тесты для сервиса валидации, проверяющие различные корректные и некорректные форматы email и паролей.
    *   **log:** Логи фиксируют попытки регистрации с невалидными данными.
    *   **policy:** Политика паролей задокументирована и доведена до сведения пользователей.

## Rollback / Fallback

Правила валидации (например, сложность пароля) могут быть временно ослаблены через конфигурацию сервера в случае массовых жалоб от пользователей.

## Trace

*   **DFD:** Ребро: `Шлюз API → Сервис` в `docs/seminars/S04/files/S04_dfd.md`.
*   **Risk scoring:** `R-02` (Top-2) в `docs/seminars/S04/files/S04_risk_scoring.md`.
*   **NFR:** `NFR-002` в `docs/seminars/S03/files/user-stories.md`.

## Ownership & Dates

*   **Owner:** `backend-dev`
*   **Date created:** 2025-10-12
