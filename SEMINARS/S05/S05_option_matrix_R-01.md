# S05 - Матрица вариантов (Option Matrix) для R-01

---

## 0) Контекст риска (из S04)

* **Risk-ID:** `R-01`     **Threat:** `S`
* **DFD element/edge:** Ребро: Интернет → Шлюз API
* **NFR link (ID):** `NFR-012`
* **L×I (1-5):** `L=4, I=5, Score=20`
* **Ограничения/предпосылки:** Публичный API, критичность пользовательских данных, необходимость поддерживать длительные сессии без частого входа.

---

## 1) Критерии и шкалы (1-5)

**Польза (чем больше - тем лучше, ↑):**

* **Security impact (↑):** Насколько альтернатива снижает риск.
* **Blast radius reduction (↑):** Насколько сужает возможный ущерб.

**Стоимость/сложность (чем меньше - тем лучше, ↓):**

* **Complexity (↓):** Сложность внедрения.
* **Time-to-mitigate (↓):** Время до эффекта.
* **Dependencies (↓):** Внешние/внутренние зависимости.

---

## 2) Таблица сравнения вариантов

| Alternative | Summary (1-2 фразы)                                                                                 | Security impact (↑,1-5) | Blast radius reduction (↑,1-5) | Complexity (↓,1-5) | Time-to-mitigate (↓,1-5) | Dependencies (↓,1-5) | **Benefit** | **Cost** | **Net** | Notes                                          |
| ----------- | --------------------------------------------------------------------------------------------------- | ----------------------: | -----------------------------: | -----------------: | -----------------------: | -------------------: | ----------: | -------: | ------: | ---------------------------------------------- |
| A           | **JWT TTL + Refresh Token.** Короткий Access Token (15m), долгий Refresh Token (7d) для обновления. |                       4 |                              4 |                  2 |                        2 |                    1 |       **8** |    **5** |  **+3** | Стандарт индустрии, хорошо документирован.     |
| B           | **Stateful JWTs.** Хранение состояния токенов на сервере (Redis) для мгновенного отзыва.            |                       5 |                              5 |                  4 |                        3 |                    3 |      **10** |   **10** |   **0** | Усложняет архитектуру, добавляет точку отказа. |

---

## 3) Тай-брейкеры при равенстве Net

Не требуется, так как Net не равен.

---

## 4) Решение (для переноса в ADR)

* **Chosen alternative:** `A`
* **Почему:** Альтернатива A (`JWT TTL + Refresh Token`) обеспечивает значительное снижение риска при умеренной сложности внедрения. Она является отраслевым стандартом, не усложняет архитектуру состоянием на стороне сервера и может быть реализована быстрее.
* **ADR candidate (название):** `JWT TTL, Refresh Token and Key Rotation`
* **Связки:** Risk-ID `R-01`, NFR-ID `NFR-012`, DFD `Интернет → Шлюз API`
* **Следующие шаги (минимум):**
    * Установить Access Token TTL = 15 минут.
    * Установить Refresh Token TTL = 7 дней.
    * Реализовать endpoint `/api/auth/refresh` для обмена Refresh Token.
    * Настроить ротацию ключей подписи (JWKS).
    * Обеспечить отзыв Refresh Token при выходе из системы.
