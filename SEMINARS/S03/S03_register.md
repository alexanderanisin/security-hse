# S03 - Шаблон реестра NFR (Given-When-Then)

## Поля реестра (data dictionary)

- **ID** - короткий идентификатор, например `NFR-001`.
- **User Story / Feature** - к какой истории/фиче относится требование (ссылка допустима).
- **Category** - выберите из банка (напр.: `Performance`, `Security-AuthZ/RBAC`, `RateLimiting`, `Privacy/PII`, `Observability/Logging`, …).
- **Requirement (NFR)** - _измеримое_ требование (числа/пороги/границы действия).
- **Rationale / Risk** - зачем это нужно, какой риск/ценность покрываем.
- **Acceptance (G-W-T)** - проверяемая формулировка: _Given … When … Then …_.
- **Evidence (test/log/scan/policy)** - чем подтвердим выполнение (тест, лог-шаблон, сканер, политика).
- **Trace (issue/link)** - ссылка на задачу, обсуждение, артефакт.
- **Owner** - ответственный.
- **Status** - `Draft` | `Proposed` | `Approved` | `Implemented` | `Verified`.
- **Priority** - `P1 - High` | `P2 - Medium` | `P3 - Low`.
- **Severity** - `S1 - Critical` | `S2 - Major` | `S3 - Minor`.
- **Tags** - произвольные метки (через запятую).

---

## Таблица реестра

| ID      | User Story / Feature                    | Category                 | Requirement (NFR)                                                                                                              | Rationale / Risk                                                               | Acceptance (G-W-T)                                                                                                                                                    | Evidence (test/log/scan/policy)                                 | Trace (issue/link) | Owner        | Status   | Priority    | Severity      | Tags                     |
| ------- | --------------------------------------- | ------------------------ | ------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------- | ------------------ | ------------ | -------- | ----------- | ------------- | ------------------------ |
| NFR-001 | US-001: Регистрация с email             | Security-AuthN           | Email верификация в течение 24ч; неверифицированные блокируются от входа.                                                      | Защита от фейковых аккаунтов и спама                                           | **Given** неверифицированный аккаунт >24ч<br>**When** POST `/api/auth/login`<br>**Then** 401 с RFC7807 "email_not_verified"                                           | test:`e2e-email-verify`; policy: auth-flow                      | #125               | backend-dev  | Proposed | P1 - High   | S1 - Critical | auth,verification        |
| NFR-002 | US-001: Валидация данных регистрации    | Security-InputValidation | Email по RFC5322; пароль ≥8 символов с цифрой и спецсимволом; payload ≤10 KiB                                                  | Защита от слабых паролей и инъекций                                            | **Given** невалидный email или пароль <8 символов<br>**When** POST `/api/auth/register`<br>**Then** 400 с RFC7807 и деталями валидации                                | test:`e2e-register-validation`; schema: user.json               | #126               | backend-dev  | Proposed | P2 - Medium | S2 - Major    | validation,security      |
| NFR-003 | US-001: Ограничение попыток регистрации | RateLimiting             | Макс 5 регистраций с IP/час; CAPTCHA после 2 попыток                                                                           | Защита от ботов и автоматической регистрации                                   | **Given** 5 регистраций с одного IP за 60 мин<br>**When** 6-я попытка POST `/api/auth/register`<br>**Then** 429 с Retry-After в секундах                              | test:`e2e-register-ratelimit`; log: rate_limit                  | #127               | team-lead    | Proposed | P2 - Medium | S2 - Major    | ratelimit,antibot        |
| NFR-004 | US-001: Защита персональных данных      | Privacy/PII              | Email маскируется в логах как ***@domain; PII хранится макс 90 дней после удаления                                             | GDPR/приватность и минимизация данных                                          | **Given** регистрация с email и личными данными<br>**When** событие логируется<br>**Then** email показан как ***@domain.com; TTL 90 дней                              | test:`e2e-pii-masking`; policy: retention.yaml                  | #128               | team-lead    | Proposed | P1 - High   | S2 - Major    | privacy,gdpr,pii         |
| NFR-005 | US-002: Лимиты загрузки аватара         | Security-InputValidation | Макс 5 MiB; MIME: image/jpeg, image/png, image/webp; запрет extra полей                                                        | Защита от DoS и загрузки вредоносных файлов                                    | **Given** файл 6 MiB или MIME text/plain<br>**When** POST `/api/files/avatar`<br>**Then** 413 для размера или 415 для типа с RFC7807                                  | test:`e2e-avatar-limits`; policy: upload.yaml                   | #129               | backend-dev  | Proposed | P2 - Medium | S2 - Major    | upload,validation,limits |
| NFR-006 | US-002: Квоты на загрузку файлов        | RateLimiting             | Макс 10 загрузок/пользователь/день; макс 3 параллельных загрузки                                                               | Контроль использования ресурсов и защита от абьюза                             | **Given** пользователь с 10 загрузками за 24ч<br>**When** 11-я попытка POST `/api/files/avatar`<br>**Then** 429 с сообщением о дневном лимите                         | test:`e2e-upload-quota`; log: user_quota                        | #130               | team-lead    | Proposed | P3 - Low    | S3 - Minor    | quota,ratelimit          |
| NFR-007 | US-003: Производительность поиска       | Performance              | P95 ≤ 500ms при 100 RPS в течение 5 минут                                                                                      | UX и выполнение SLO для поисковых запросов                                     | **Given** сервис здоров и данные проиндексированы<br>**When** 100 RPS на `/api/search` 5 минут<br>**Then** P95 ≤ 500ms; error rate ≤ 1%                               | test:`load-search-100rps`; metric: search_latency               | #131               | frontend-dev | Proposed | P1 - High   | S2 - Major    | perf,search,slo          |
| NFR-008 | US-003: Ограничения поисковых запросов  | RateLimiting             | Макс 30 поисков/мин/пользователь; строка запроса ≤100 символов                                                                 | Защита от перегрузки и злоупотребления поиском                                 | **Given** 30 запросов за 60 сек от пользователя<br>**When** 31-й GET `/api/search`<br>**Then** 429 с Retry-After до сброса счетчика                                   | test:`e2e-search-ratelimit`; log: search_limit                  | #132               | frontend-dev | Proposed | P2 - Medium | S3 - Minor    | search,ratelimit         |
| NFR-009 | Для всей системы                        | Security-DataIntegrity   | Все запросы к БД должны использовать параметризованные запросы или ORM для предотвращения SQL-инъекций.                        | Предотвращение несанкционированного доступа и изменения данных через SQL-инъекции. | **Дано** исходный код прошел статическую проверку<br>**Когда** выполняется запрос к БД<br>**Тогда** запрос параметризован и не содержит конкатенации строк.           | SAST-правило, ревью кода                                        | #133               | backend-dev  | Proposed | P1 - High   | S1 - Critical | data-integrity,security  |
| NFR-010 | Для всей системы                        | Security-Audit           | Все операции записи (CREATE, UPDATE, DELETE) в критичные таблицы должны логироваться в неизменяемый журнал.                    | Обеспечение неотказуемости и возможности расследования инцидентов.             | **Дано** пользователь выполнил операцию записи<br>**Когда** операция завершена<br>**Тогда** в журнале аудита создана соответствующая запись.                          | test:`e2e-audit-log`; log: `audit_trail`                        | #134               | team-lead    | Proposed | P2 - Medium | S2 - Major    | audit,logging,security   |
| NFR-011 | Для всей системы                        | Resilience               | Внешние вызовы должны иметь таймаут 2с, 3 повтора с экспоненциальной задержкой и `circuit breaker`.                        | Предотвращение каскадных сбоев при недоступности внешних зависимостей.         | **Дано** внешний сервис не отвечает<br>**Когда** наш сервис его вызывает<br>**Тогда** вызов прерывается по таймауту, и `circuit breaker` размыкается после 5 неудач.  | test:`e2e-resilience-patterns`; metric: `circuit_breaker_state` | #135               | backend-dev  | Proposed | P2 - Medium | S2 - Major    | resilience,timeout,retry |
| NFR-012 | US-001: Регистрация с email             | Security-AuthN           | Для аутентификации используется JWT со сроком жизни токена 24 часа.                                                            | Ограничение времени сессии пользователя для снижения риска захвата сессии.     | **Дано** пользователь успешно аутентифицировался<br>**Когда** прошло 24 часа<br>**Тогда** JWT токен становится недействительным.                                       | test:`e2e-jwt-expiration`                                       | #136               | backend-dev  | Proposed | P1 - High   | S2 - Major    | auth,jwt,security        |
